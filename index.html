<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Pusat Game Bahasa Jepang</title>
    <style>
        :root{
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary-color: #db2777;
            --secondary-hover: #be185d;
            --correct-bg: #dcfce7;
            --correct-border: #22c55e;
            --correct-text: #166534;
            --incorrect-bg: #fee2e2;
            --incorrect-border: #ef4444;
            --incorrect-text: #991b1b;
            --neutral-bg: #f1f5f9;
            --text-dark: #1e293b;
            --text-light: #475569;
        }
        * { box-sizing: border-box; }
        body{
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin:0;
            min-height:100vh;
            display:flex;
            align-items:center;
            justify-content:center;
            background-color:var(--neutral-bg);
            padding:20px;
        }
        .container{
            width:100%;
            max-width:820px;
            background:white;
            padding:24px;
            border-radius:12px;
            box-shadow:0 10px 25px rgba(2,6,23,0.08);
        }
        h1,h2,h3{ color:var(--text-dark); margin:8px 0; }
        p{ color:var(--text-light); margin:6px 0 12px 0; }

        .btn{
            display:inline-block;
            padding:10px 18px;
            margin:6px 6px 6px 0;
            border-radius:8px;
            border:none;
            background:var(--primary-color);
            color:white;
            font-weight:600;
            cursor:pointer;
        }
        .btn:hover{ background:var(--primary-hover); }
        .btn-secondary{ background:#64748b; }
        .btn-kana{ background:var(--secondary-color); }
        .btn-kana:hover{ background:var(--secondary-hover); }

        .selection-group{ margin:18px 0; padding-top:12px; border-top:1px solid #e6eefb; text-align:left; }

        .hidden{ display:none; }

        /* MUSIC CONTROL */
        #music-control{
            position:fixed;
            right:16px;
            bottom:16px;
            width:52px;
            height:52px;
            border-radius:50%;
            background:rgba(0,0,0,0.6);
            color:white;
            font-size:22px;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            z-index:1000;
            opacity:0;
            transition:opacity .3s;
        }
        #music-control.visible{ opacity:1; }

        /* popup music */
        #music-popup-overlay{
            position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
            background:rgba(0,0,0,0.45); z-index:2000;
        }
        #music-popup-box{
            background:white; padding:26px; border-radius:12px; width:92%; max-width:420px; box-shadow:0 8px 30px rgba(2,6,23,0.2);
            animation:slideDown .6s cubic-bezier(.25,.46,.45,.94) forwards;
            text-align:center;
        }
        #music-popup-box.slide-up{ animation:slideUp .45s cubic-bezier(.55,.085,.68,.53) forwards; }
        @keyframes slideDown { from{transform:translateY(-150%);opacity:0} to{transform:none;opacity:1} }
        @keyframes slideUp { from{transform:none;opacity:1} to{transform:translateY(-150%);opacity:0} }

        /* MC layout */
        .mc-card, .kana-card {
            margin-top:18px;
            padding:18px;
            border-radius:10px;
            border:1px solid #eef6ff;
            background:linear-gradient(180deg,#fff,#fbfdff);
            text-align:left;
        }
        .mc-options { display:flex; flex-direction:column; gap:8px; margin-top:12px; }
        .option-btn{
            padding:10px 12px; border-radius:8px; border:1px solid #e6eefb; background:white; text-align:left; cursor:pointer; font-weight:600;
        }
        .option-btn.correct { background:var(--correct-bg); border-color:var(--correct-border); color:var(--correct-text); }
        .option-btn.incorrect { background:var(--incorrect-bg); border-color:var(--incorrect-border); color:var(--incorrect-text); }

        .footer-controls{ display:flex; justify-content:space-between; align-items:center; margin-top:14px; flex-wrap:wrap; gap:8px; }

        .score-badge{ padding:8px 12px; border-radius:999px; background:#f8fafc; border:1px solid #e6eefb; font-weight:700; color:var(--text-dark); }

        .center{ text-align:center; }

        /* responsive tweaks */
        @media (max-width:600px){
            .footer-controls{ flex-direction:column; align-items:stretch; }
            .btn{ width:100%; }
        }
    </style>
</head>
<body>
    <!-- MUSIC POPUP -->
    <div id="music-popup-overlay" role="dialog" aria-modal="true">
        <div id="music-popup-box">
            <h3>Musik Latar</h3>
            <p>Apakah Anda ingin memutar musik selama bermain?</p>
            <div style="display:flex; justify-content:center; gap:12px;">
                <button id="play-music-btn" class="btn">Ya, Putar</button>
                <button id="no-music-btn" class="btn btn-secondary">Tidak</button>
            </div>
        </div>
    </div>

    <!-- audio file (ganti src dengan file Anda) -->
    <audio id="background-music" src="sore1.mp3" loop></audio>
    <button id="music-control" class="hidden" title="Kontrol Musik">üîä</button>

    <div class="container" id="app">
        <!-- KATEGORI UTAMA -->
        <div id="category-screen">
            <h1>Pusat Game Bahasa Jepang</h1>
            <p>Pilih materi yang ingin kamu pelajari hari ini. Ada tes kosakata dan tes huruf kana (hiragana/katakana).</p>

            <div class="selection-group">
                <h3>Tes Kosakata (Multiple-choice)</h3>
                <button class="btn" onclick="chooseVocab('classroom')">Ungkapan di Kelas</button>
                <button class="btn" onclick="chooseVocab('daily')">Salam Sehari-hari</button>
                <button class="btn" onclick="chooseVocab('intro')">Perkenalan Diri</button>
            </div>

            <div class="selection-group">
                <h3>Tes Huruf Kana</h3>
                <button class="btn btn-kana" onclick="startKanaTest('hiragana')">Tes Hiragana (pilih romaji)</button>
                <button class="btn btn-kana" onclick="startKanaTest('katakana')">Tes Katakana (pilih romaji)</button>
            </div>
        </div>

        <!-- SELECTION SCREEN (setelah pilih kategori vocab) -->
        <div id="game-selection-screen" class="hidden">
            <h2 id="game-selection-title">Judul</h2>
            <p id="game-selection-desc">Pilih mode atau mulai tes.</p>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button class="btn" onclick="startVocabMC()">Mulai Tes (10 soal)</button>
                <button class="btn btn-secondary" onclick="backToCategory()">Kembali</button>
            </div>
        </div>

        <!-- MULTIPLE CHOICE SCREEN -->
        <div id="mc-screen" class="hidden">
            <h2 id="mc-title">Soal</h2>
            <div class="mc-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong id="mc-question-text">Pertanyaan akan muncul di sini</strong>
                        <div style="font-size:0.95em; color:var(--text-light);" id="mc-subtext">Terjemahan/Instruksi</div>
                    </div>
                    <div class="score-badge" id="mc-progress">0 / 10</div>
                </div>

                <div class="mc-options" id="mc-options">
                    <!-- tombol opsi di-generate oleh JS -->
                </div>

                <div class="footer-controls">
                    <div>
                        <button class="btn btn-secondary" id="mc-next-btn" disabled>Berikutnya</button>
                        <button class="btn" onclick="endGameEarly()">Selesai</button>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <div class="score-badge">Benar: <span id="mc-correct">0</span></div>
                        <div class="score-badge">Salah: <span id="mc-incorrect">0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KANA TEST SCREEN -->
        <div id="kana-screen" class="hidden">
            <h2 id="kana-title">Tes Kana</h2>
            <div class="kana-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div class="center" style="flex:1;">
                        <div style="font-size:86px; font-weight:800;" id="kana-char">„ÅÇ</div>
                        <div style="margin-top:8px; color:var(--text-light);" id="kana-instruction">Pilih romaji yang sesuai</div>
                    </div>
                    <div style="width:180px;">
                        <div class="score-badge" style="display:block; text-align:center;">Skor: <span id="kana-score">0</span></div>
                        <div class="score-badge" style="display:block; margin-top:10px; text-align:center;" id="kana-progress">0/10</div>
                    </div>
                </div>

                <div class="mc-options" id="kana-options" style="margin-top:16px;">
                    <!-- opsi romaji -->
                </div>

                <div class="footer-controls" style="margin-top:14px;">
                    <div>
                        <button class="btn btn-secondary" onclick="stopKanaTest()">Kembali</button>
                        <button class="btn" id="kana-next-btn" disabled>Berikutnya</button>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <div class="score-badge">Benar: <span id="kana-correct">0</span></div>
                        <div class="score-badge">Salah: <span id="kana-incorrect">0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- END SCREEN -->
        <div id="end-screen" class="hidden center">
            <h2>Hasil Tes</h2>
            <p id="end-desc">Keterangan hasil</p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:12px;">
                <button class="btn" onclick="restartFromEnd()">Main Lagi</button>
                <button class="btn btn-secondary" onclick="backToCategory()">Kembali ke Menu</button>
            </div>
        </div>

    </div>

    <script>
        /* ------------------- DATA ------------------- */
        const vocabData = {
            classroom: [
                { jp: "Hajimemashou", id: "Mari kita mulai" },
                { jp: "Owarimashou", id: "Mari kita akhiri" },
                { jp: "Yasumimashou", id: "Mari kita beristirahat" },
                { jp: "Wakarimasuka", id: "Apakah Anda mengerti?" },
                { jp: "Hai, wakarimasu", id: "Ya, mengerti" },
                { jp: "Iie, wakarimasen", id: "Tidak, tidak mengerti" },
                { jp: "Itte kudasai", id: "Mohon ucapkan" },
                { jp: "Mou ichido itte kudasai", id: "Ucapkan sekali lagi" },
                { jp: "Yukkuri itte kudasai", id: "Ucapkan perlahan-lahan" },
                { jp: "Isshoni douzo", id: "Mari bersama-sama" },
                { jp: "Kaite kudasai", id: "Tolong tulis" },
                { jp: "Yonde kudasai", id: "Tolong baca" },
                { jp: "Hon o akete kudasai", id: "Buka bukunya" },
                { jp: "Hon o tojite kudasai", id: "Tutup bukunya" },
                { jp: "Renshuu shite kudasai", id: "Berlatihlah" },
                { jp: "Korede owarimasu", id: "Sampai di sini dulu" },
                { jp: "Shitsumon ga arimasu ka", id: "Ada pertanyaan?" },
                { jp: "Hai, arimasu", id: "Ya, ada" },
                { jp: "Iie, arimasen", id: "Tidak, tidak ada" },
                { jp: "Chotto matte kudasai", id: "Tunggu sebentar" }
            ],
            daily: [
                { jp: "Ohayou gozaimasu", id: "Selamat pagi" },
                { jp: "Konnichiwa", id: "Selamat siang" },
                { jp: "Konbanwa", id: "Selamat malam" },
                { jp: "Sayounara", id: "Selamat tinggal" },
                { jp: "Oyasuminasai", id: "Selamat tidur" },
                { jp: "Omedetou gozaimasu", id: "Selamat" },
                { jp: "Doumo arigatou gozaimasu", id: "Terima kasih" },
                { jp: "Douitashimashite", id: "Sama-sama" },
                { jp: "Itadakimasu", id: "Terima kasih sebelum makan" },
                { jp: "Gochisousama deshita", id: "Terima kasih setelah makan" },
                { jp: "Sumimasen", id: "Permisi/maaf" },
                { jp: "Gomen nasai", id: "Maaf" }
            ],
            intro: [
                { jp: "Hajimemashite", id: "Perkenalkan" },
                { jp: "Watashi wa [nama] to moushimasu", id: "Nama saya ..." },
                { jp: "[daerah asal] kara kimashita", id: "Saya datang dari ..." },
                { jp: "Douzo yoroshiku onegaishimasu", id: "Senang berkenalan" },
                { jp: "Kochira koso, yoroshiku onegaishimasu", id: "Senang berkenalan juga" }
            ]
        };

        const kanaData = {
            hiragana: [
                { kana: '„ÅÇ', romaji: 'a' }, { kana: '„ÅÑ', romaji: 'i' }, { kana: '„ÅÜ', romaji: 'u' }, { kana: '„Åà', romaji: 'e' }, { kana: '„Åä', romaji: 'o' },
                { kana: '„Åã', romaji: 'ka' }, { kana: '„Åç', romaji: 'ki' }, { kana: '„Åè', romaji: 'ku' }, { kana: '„Åë', romaji: 'ke' }, { kana: '„Åì', romaji: 'ko' },
                { kana: '„Åï', romaji: 'sa' }, { kana: '„Åó', romaji: 'shi' }, { kana: '„Åô', romaji: 'su' }, { kana: '„Åõ', romaji: 'se' }, { kana: '„Åù', romaji: 'so' },
                { kana: '„Åü', romaji: 'ta' }, { kana: '„Å°', romaji: 'chi' }, { kana: '„Å§', romaji: 'tsu' }, { kana: '„Å¶', romaji: 'te' }, { kana: '„Å®', romaji: 'to' },
                { kana: '„Å™', romaji: 'na' }, { kana: '„Å´', romaji: 'ni' }, { kana: '„Å¨', romaji: 'nu' }, { kana: '„Å≠', romaji: 'ne' }, { kana: '„ÅÆ', romaji: 'no' },
                { kana: '„ÅØ', romaji: 'ha' }, { kana: '„Å≤', romaji: 'hi' }, { kana: '„Åµ', romaji: 'fu' }, { kana: '„Å∏', romaji: 'he' }, { kana: '„Åª', romaji: 'ho' },
                { kana: '„Åæ', romaji: 'ma' }, { kana: '„Åø', romaji: 'mi' }, { kana: '„ÇÄ', romaji: 'mu' }, { kana: '„ÇÅ', romaji: 'me' }, { kana: '„ÇÇ', romaji: 'mo' },
                { kana: '„ÇÑ', romaji: 'ya' }, { kana: '„ÇÜ', romaji: 'yu' }, { kana: '„Çà', romaji: 'yo' },
                { kana: '„Çâ', romaji: 'ra' }, { kana: '„Çä', romaji: 'ri' }, { kana: '„Çã', romaji: 'ru' }, { kana: '„Çå', romaji: 're' }, { kana: '„Çç', romaji: 'ro' },
                { kana: '„Çè', romaji: 'wa' }, { kana: '„Çí', romaji: 'wo' }, { kana: '„Çì', romaji: 'n' }
            ],
            katakana: [
                { kana: '„Ç¢', romaji: 'a' }, { kana: '„Ç§', romaji: 'i' }, { kana: '„Ç¶', romaji: 'u' }, { kana: '„Ç®', romaji: 'e' }, { kana: '„Ç™', romaji: 'o' },
                { kana: '„Ç´', romaji: 'ka' }, { kana: '„Ç≠', romaji: 'ki' }, { kana: '„ÇØ', romaji: 'ku' }, { kana: '„Ç±', romaji: 'ke' }, { kana: '„Ç≥', romaji: 'ko' },
                { kana: '„Çµ', romaji: 'sa' }, { kana: '„Ç∑', romaji: 'shi' }, { kana: '„Çπ', romaji: 'su' }, { kana: '„Çª', romaji: 'se' }, { kana: '„ÇΩ', romaji: 'so' },
                { kana: '„Çø', romaji: 'ta' }, { kana: '„ÉÅ', romaji: 'chi' }, { kana: '„ÉÑ', romaji: 'tsu' }, { kana: '„ÉÜ', romaji: 'te' }, { kana: '„Éà', romaji: 'to' },
                { kana: '„Éä', romaji: 'na' }, { kana: '„Éã', romaji: 'ni' }, { kana: '„Éå', romaji: 'nu' }, { kana: '„Éç', romaji: 'ne' }, { kana: '„Éé', romaji: 'no' },
                { kana: '„Éè', romaji: 'ha' }, { kana: '„Éí', romaji: 'hi' }, { kana: '„Éï', romaji: 'fu' }, { kana: '„Éò', romaji: 'he' }, { kana: '„Éõ', romaji: 'ho' },
                { kana: '„Éû', romaji: 'ma' }, { kana: '„Éü', romaji: 'mi' }, { kana: '„É†', romaji: 'mu' }, { kana: '„É°', romaji: 'me' }, { kana: '„É¢', romaji: 'mo' },
                { kana: '„É§', romaji: 'ya' }, { kana: '„É¶', romaji: 'yu' }, { kana: '„É®', romaji: 'yo' },
                { kana: '„É©', romaji: 'ra' }, { kana: '„É™', romaji: 'ri' }, { kana: '„É´', romaji: 'ru' }, { kana: '„É¨', romaji: 're' }, { kana: '„É≠', romaji: 'ro' },
                { kana: '„ÉØ', romaji: 'wa' }, { kana: '„É≤', romaji: 'wo' }, { kana: '„É≥', romaji: 'n' }
            ]
        };

        /* ------------------- HELPERS ------------------- */
        function shuffleArray(arr){
            const a = arr.slice();
            for(let i=a.length-1;i>0;i--){
                const j = Math.floor(Math.random()*(i+1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }
        function pickRandomExcept(list, except, n){
            const pool = list.filter(x => x !== except);
            return shuffleArray(pool).slice(0, n);
        }

        /* ------------------- NAV / UI ------------------- */
        const screens = {
            category: document.getElementById('category-screen'),
            selection: document.getElementById('game-selection-screen'),
            mc: document.getElementById('mc-screen'),
            kana: document.getElementById('kana-screen'),
            end: document.getElementById('end-screen')
        };
        function showScreen(name){
            Object.values(screens).forEach(el => el.classList.add('hidden'));
            screens[name].classList.remove('hidden');
        }
        function backToCategory(){
            // reset any temp states
            currentCategory = null;
            currentGameType = null;
            showScreen('category');
        }

        /* ------------------- MUSIC POPUP ------------------- */
        const music = document.getElementById('background-music');
        const musicControlBtn = document.getElementById('music-control');
        const musicPopupOverlay = document.getElementById('music-popup-overlay');
        const musicPopupBox = document.getElementById('music-popup-box');
        const playMusicBtn = document.getElementById('play-music-btn');
        const noMusicBtn = document.getElementById('no-music-btn');
        let isMusicPlaying = false;
        music.volume = 0.3;

        function hidePopup(){
            musicPopupBox.classList.add('slide-up');
            setTimeout(()=> {
                musicPopupOverlay.classList.add('hidden');
                musicControlBtn.classList.remove('hidden');
                musicControlBtn.classList.add('visible');
                document.body.style.overflow = 'auto';
            }, 480);
        }

        function playMusic(){
            hidePopup();
            music.play().then(()=> {
                isMusicPlaying = true;
                musicControlBtn.textContent = 'üîä';
            }).catch(()=> {
                isMusicPlaying = false;
                musicControlBtn.textContent = 'üîá';
            });
        }
        function declineMusic(){
            hidePopup();
            isMusicPlaying = false;
            musicControlBtn.textContent = 'üîá';
        }
        playMusicBtn.addEventListener('click', playMusic);
        noMusicBtn.addEventListener('click', declineMusic);
        musicControlBtn.addEventListener('click', ()=>{
            if(isMusicPlaying){
                music.pause();
                musicControlBtn.textContent = 'üîá';
            } else {
                music.play();
                musicControlBtn.textContent = 'üîä';
            }
            isMusicPlaying = !isMusicPlaying;
        });

        /* ------------------- VOCAB MULTIPLE CHOICE LOGIC ------------------- */
        let currentCategory = null;
        let currentGameType = null;
        let mcQuestions = [];
        let mcIndex = 0;
        let mcCorrect = 0, mcIncorrect = 0;
        const MC_TOTAL = 10;

        function chooseVocab(category){
            currentCategory = category;
            document.getElementById('game-selection-title').textContent = {
                classroom: 'Ungkapan di Kelas',
                daily: 'Salam Sehari-hari',
                intro: 'Perkenalan Diri'
            }[category] || 'Kosakata';
            document.getElementById('game-selection-desc').textContent = 'Mode multiple-choice: pilih arti yang benar untuk ungkapan bahasa Jepang.';
            showScreen('selection');
        }

        function startVocabMC(){
            currentGameType = 'vocab-mc';
            // prepare questions (shuffle)
            const pool = shuffleArray(vocabData[currentCategory]);
            mcQuestions = pool.slice(0, Math.min(MC_TOTAL, pool.length));
            mcIndex = 0; mcCorrect = 0; mcIncorrect = 0;
            document.getElementById('mc-correct').textContent = mcCorrect;
            document.getElementById('mc-incorrect').textContent = mcIncorrect;
            showMcQuestion();
            showScreen('mc');
        }

        function showMcQuestion(){
            const qObj = mcQuestions[mcIndex];
            document.getElementById('mc-question-text').textContent = qObj.jp;
            document.getElementById('mc-subtext').textContent = 'Pilih arti yang benar.';
            document.getElementById('mc-progress').textContent = (mcIndex+1) + ' / ' + mcQuestions.length;
            // build options: correct + 3 random wrongs (from whole category)
            const optionsContainer = document.getElementById('mc-options');
            optionsContainer.innerHTML = '';
            const wrongPool = vocabData[currentCategory].map(x=>x.id).filter(t => t !== qObj.id);
            const wrongs = pickRandomExcept(wrongPool, qObj.id, 3);
            const candidates = shuffleArray([qObj.id, ...wrongs]);
            candidates.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt;
                btn.addEventListener('click', ()=> checkMcAnswer(btn, opt, qObj.id));
                optionsContainer.appendChild(btn);
            });
            document.getElementById('mc-next-btn').disabled = true;
        }

        function checkMcAnswer(button, selected, correct){
            // disable all buttons
            const btns = Array.from(document.querySelectorAll('#mc-options .option-btn'));
            btns.forEach(b => b.disabled = true);
            if(selected === correct){
                button.classList.add('correct');
                mcCorrect++;
                document.getElementById('mc-correct').textContent = mcCorrect;
            } else {
                button.classList.add('incorrect');
                mcIncorrect++;
                document.getElementById('mc-incorrect').textContent = mcIncorrect;
                // show correct
                const correctBtn = btns.find(b => b.textContent === correct);
                if(correctBtn) correctBtn.classList.add('correct');
            }
            document.getElementById('mc-next-btn').disabled = false;
        }

        document.getElementById('mc-next-btn').addEventListener('click', ()=>{
            mcIndex++;
            if(mcIndex >= mcQuestions.length){
                // selesai
                showMcEnd();
            } else {
                showMcQuestion();
            }
        });

        function showMcEnd(){
            const total = mcQuestions.length;
            const desc = `Benar ${mcCorrect} dari ${total}.`;
            document.getElementById('end-desc').textContent = desc;
            showScreen('end');
        }

        function endGameEarly(){
            // if user clicks selesai sebelum habis
            const totalAnswered = mcCorrect + mcIncorrect;
            const desc = `Anda menghentikan permainan. Benar: ${mcCorrect}, Salah: ${mcIncorrect}, Terjawab: ${totalAnswered}.`;
            document.getElementById('end-desc').textContent = desc;
            showScreen('end');
        }

        function restartFromEnd(){
            // jika dari vocab, ulangi game yang sama; jika dari kana, biarkan user pilih
            if(currentGameType === 'vocab-mc') startVocabMC();
            else backToCategory();
        }

        /* ------------------- KANA TEST LOGIC ------------------- */
        let kanaType = null;
        let kanaPool = [];
        let kanaIndex = 0;
        let kanaCorrect = 0, kanaIncorrect = 0;
        const KANA_TOTAL = 10;

        function startKanaTest(type){
            kanaType = type; // 'hiragana' or 'katakana'
            const title = type === 'hiragana' ? 'Tes Hiragana' : 'Tes Katakana';
            document.getElementById('kana-title').textContent = title;
            // prepare pool
            kanaPool = shuffleArray(kanaData[type]).slice(0, Math.min(KANA_TOTAL, kanaData[type].length));
            kanaIndex = 0; kanaCorrect = 0; kanaIncorrect = 0;
            document.getElementById('kana-correct').textContent = kanaCorrect;
            document.getElementById('kana-incorrect').textContent = kanaIncorrect;
            document.getElementById('kana-score').textContent = 0;
            showKanaQuestion();
            showScreen('kana');
        }

        function showKanaQuestion(){
            const obj = kanaPool[kanaIndex];
            document.getElementById('kana-char').textContent = obj.kana;
            document.getElementById('kana-progress').textContent = (kanaIndex+1) + ' / ' + kanaPool.length;
            // generate 4 options: correct romaji + 3 wrong romaji from same set
            const wrongs = pickRandomExcept(kanaData[kanaType].map(x=>x.romaji), obj.romaji, 3);
            const options = shuffleArray([obj.romaji, ...wrongs]);
            const container = document.getElementById('kana-options');
            container.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt;
                btn.addEventListener('click', ()=> checkKanaAnswer(btn, opt, obj.romaji));
                container.appendChild(btn);
            });
            document.getElementById('kana-next-btn').disabled = true;
        }

        function checkKanaAnswer(button, selected, correct){
            const btns = Array.from(document.querySelectorAll('#kana-options .option-btn'));
            btns.forEach(b => b.disabled = true);
            if(selected === correct){
                button.classList.add('correct');
                kanaCorrect++;
            } else {
                button.classList.add('incorrect');
                kanaIncorrect++;
                const correctBtn = btns.find(b => b.textContent === correct);
                if(correctBtn) correctBtn.classList.add('correct');
            }
            document.getElementById('kana-correct').textContent = kanaCorrect;
            document.getElementById('kana-incorrect').textContent = kanaIncorrect;
            document.getElementById('kana-score').textContent = kanaCorrect;
            document.getElementById('kana-next-btn').disabled = false;
        }

        document.getElementById('kana-next-btn').addEventListener('click', ()=>{
            kanaIndex++;
            if(kanaIndex >= kanaPool.length){
                // selesai
                const desc = `Tes ${kanaType === 'hiragana' ? 'Hiragana' : 'Katakana'} selesai. Skor: ${kanaCorrect} / ${kanaPool.length}.`;
                document.getElementById('end-desc').textContent = desc;
                // reset currentGameType so restartFromEnd knows
                currentGameType = 'kana';
                showScreen('end');
            } else {
                showKanaQuestion();
            }
        });

        function stopKanaTest(){
            // kembali ke kategori
            backToCategory();
        }

        /* ------------------- INIT ------------------- */
        // Show main category screen at start
        showScreen('category');

        // Note: popup visible by default (in DOM). If you want to hide on small devices, adapt here.
    </script>
</body>
</html>
